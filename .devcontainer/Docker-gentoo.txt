FROM gentoo/stage3:latest

RUN emerge --sync

RUN echo 'CFLAGS="-march=native -mtune=native -O3 -pipe"' >> /etc/portage/make.conf
RUN echo 'CXXFLAGS="${CFLAGS}"' >> /etc/portage/make.conf
RUN echo 'USE="${USE} -examples static-libs system system-bootstrap system-llvm"' >> /etc/portage/make.conf

RUN echo "dev-libs/boost **" > /etc/portage/package.accept_keywords/boost
RUN echo "dev-util/b2 **" >> /etc/portage/package.accept_keywords/boost
RUN echo "dev-util/boost-build **" >> /etc/portage/package.accept_keywords/boost
RUN echo "dev-libs/boost icu lzma python test" > /etc/portage/package.use/boost

RUN echo "dev-util/cmake **" > /etc/portage/package.accept_keywords/cmake
RUN echo "dev-libs/icu examples static-libs" > /etc/portage/package.use/icu
RUN echo "dev-lang/mono minimal" > /etc/portage/package.use/mono

RUN emerge --update \
    dev-vcs/git \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge --update \
    kde-frameworks/extra-cmake-modules \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge --update \
    clang \
    lld \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge -j`nproc` leveldb && rm -rf /var/cache/distfiles

RUN emerge --update \
    app-arch/lz4 \
    dev-libs/icu \
    dev-libs/openssl \
    sys-process/htop \
    sys-libs/zlib \
    x11-libs/libX11 \
    x11-libs/libxcb \
    x11-libs/libXScrnSaver \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge --update \
    dev-libs/icu \
    -j`nproc` && rm -rf /var/cache/distfiles
    
RUN emerge --update \
    gdb \
    lldb \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge --update =dev-libs/boost-1.80.0 -j`nproc`

# FoundationDB deps
RUN emerge --update dev-cpp/benchmark dev-cpp/gtest -j`nproc` && rm -rf /var/cache/distfiles
RUN emerge --update dev-lang/mono -j`nproc` && rm -rf /var/cache/distfiles

RUN emerge --update \
    app-misc/mc \
    bash-completion \
    eix \
    sys-process/htop \
    -j`nproc` && rm -rf /var/cache/distfiles

RUN eix-update
