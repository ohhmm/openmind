FROM gentoo/stage3:latest

RUN emerge --sync

RUN echo 'CFLAGS="-march=native -mtune=native -O3 -pipe"' > /etc/make.conf
RUN echo 'CXXFLAGS="${CFLAGS}"' >> /etc/make.conf
RUN echo 'USE="${USE} -examples static-libs system system-bootstrap system-llvm"' >> /etc/make.conf

RUN echo "dev-libs/boost **" > /etc/portage/package.accept_keywords/boost
RUN echo "dev-util/boost-build **" >> /etc/portage/package.accept_keywords/boost
RUN echo "dev-libs/boost icu lzma python test" > /etc/portage/package.use/boost

RUN emerge \
    bash-completion \
    clang \
    eix \
    htop \
    app-misc/mc \
    kde-frameworks/extra-cmake-modules \
    sys-process/htop \
    dev-vcs/git \
    -j`nproc`

RUN eix-update

RUN emerge -j`nproc` leveldb

RUN emerge \
    app-arch/lz4 \
    dev-libs/icu \
    dev-libs/openssl \
    sys-process/htop \
    sys-libs/zlib \
    x11-libs/libX11 \
    x11-libs/libxcb \
    x11-libs/libXScrnSaver \
    -j`nproc`

RUN echo "dev-libs/icu examples static-libs" > /etc/portage/package.use/icu
RUN emerge \
    dev-libs/icu \
    -j`nproc`
    
RUN emerge \
    gdb \
    lldb \
    -j`nproc`

RUN emerge \
    =dev-libs/boost-1.79.0 \
    -j`nproc`
RUN sed -i 's/image_read_info< targa_tag >()/image_read_info()/g' /usr/include/boost/gil/extension/io/targa/tags.hpp

# FoundationDB deps
RUN echo "dev-lang/mono minimal" > /etc/portage/package.use/mono
RUN emerge --update dev-lang/mono -j`nproc`
RUN emerge --update \
    dev-cpp/benchmark \
    dev-cpp/gtest \
    -j`nproc`
#RUN ( cd /var/db/repos/gentoo/dev-libs/boost/ && cp boost-1.79.0.ebuild boost-1.78.0.ebuild )
#RUN emerge =dev-libs/boost-1.78.0 -j`nproc`
