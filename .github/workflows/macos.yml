name: C/C++ CI macOS

on: [push]

jobs:
  build-in-macos:
    runs-on: macos-latest
    env:
      CACHE_KEY: cache-v1
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Ninja
      run: brew install ninja

    - name: Create Build Dir
      run: cmake -E make_directory ${{github.workspace}}/build

    - name: Install vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git ${{github.workspace}}/vcpkg
        cd ${{github.workspace}}/vcpkg
        git fetch origin
        git checkout 96dbba1e03d1ecc7c7096e97d5a09ff3c58e21df
        ./bootstrap-vcpkg.sh
        ./vcpkg install --triplet arm64-osx

    - name: Set environment variables
      run: |
        echo "VCPKG_ROOT=${{github.workspace}}/vcpkg" >> $GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
        echo "VCPKG_DEFAULT_TRIPLET=arm64-osx" >> $GITHUB_ENV
        echo "VCPKG_INSTALLED_DIR=${{github.workspace}}/vcpkg/installed" >> $GITHUB_ENV

    - name: Configure CMake
      working-directory: ${{github.workspace}}/build
      run: |
        cmake ${{github.workspace}} \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=arm64-osx \
          -DCMAKE_BUILD_TYPE=Release \
          -DOPENMIND_USE_VCPKG=ON \
          -DOPENMIND_USE_CONAN=OFF \
          -DOPENMIND_BUILD_SAMPLES=OFF \
          -DOPENMIND_BUILD_TESTS=ON \
          -DOPENMIND_MATH_USE_LEVELDB_CACHE=OFF \
          -DOPENMIND_STORAGE_LEVELDB=OFF

    - name: Build
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config Release -j $(sysctl -n hw.ncpu)

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: ctest --timeout 3200 -C Release -j $(sysctl -n hw.ncpu) -E ts
